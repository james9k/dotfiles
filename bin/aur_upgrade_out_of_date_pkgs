#!/bin/bash

TMPFILE="$(mktemp)"
UPGRADE="${UPGRADE:-true}"

print_divider() {
    echo "#####################################################################"
}

if ! command -v package-query &> /dev/null
then
    echo "package-query could not be found"
    exit
fi

pacman -Qm > "${TMPFILE}"
cat "${TMPFILE}"
print_divider

while read -r line; do
    pkg_name="$(echo "${line}" | cut -d' ' -f1)"

    query_result="$(package-query --aur --nocolor --upgrades "${pkg_name}")"

    current_version="$(echo "${query_result}" | cut -d' ' -f2)"
    newer_version="$(echo "${query_result}" | cut -d' ' -f4)"

    if [ "${current_version}" != "${newer_version}" ]; then
        echo "${pkg_name}: ${current_version} --> ${newer_version}"
        sleep 1
        if [ "${UPGRADE}" == "true" ]; then
            aur_upgrade_pkg "${pkg_name}"
        fi
        print_divider
    fi
done <"${TMPFILE}"


rm "${TMPFILE}"
